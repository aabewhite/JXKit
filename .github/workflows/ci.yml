name: JXKit CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches:
      - '*'
  schedule:
    # run at 9AM & 9PM UTC
    - cron:  '0 9,21 * * *'

jobs:
  Linux:
    runs-on: ubuntu-latest
    steps:
      - run: sudo apt-get update
      - name: Install dependencies
        run: sudo apt-get install -y libjavascriptcoregtk-4.0-dev
      - run: pkg-config --libs javascriptcoregtk-4.0
      - uses: actions/checkout@v2
      - name: Test (Debug)
        run: swift test -v --configuration debug
      - name: Test (Release)
        run: swift test -v --configuration release -Xswiftc -enable-testing

  iOS:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
            xcodebuild clean test \
              -configuration Release \
              -scheme "JXKit" \
              -sdk "iphonesimulator" \
              -destination "platform=iOS Simulator,name=iPod touch (7th generation)" \
              ONLY_ACTIVE_ARCH=NO CODE_SIGNING_REQUIRED=NO

  tvOS:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - run: |
            xcodebuild clean test \
              -configuration Release \
              -scheme "JXKit" \
              -sdk "appletvsimulator" \
              -destination "platform=tvOS Simulator,name=Apple TV" \
              ONLY_ACTIVE_ARCH=NO CODE_SIGNING_REQUIRED=NO

  macOS:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - name: Test (Debug)
        run: swift test -v --configuration debug
      - name: Test (Release)
        run: swift test -v --configuration release -Xswiftc -enable-testing

  Windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install JavaScriptCore.dll
        run: |
          Install-Binary -Url "https://secure-appldnld.apple.com/itunes12/001-97787-20210421-F0E5A3C2-A2C9-11EB-A40B-A128318AD179/iTunes64Setup.exe" -Name "iTunes64Setup.exe" -ArgumentList ("-q")

      - uses: MaxDesiatov/swift-windows-action@v1
        with:
          swift-version: "5.6.3"
          shell-action: swift test -v --configuration release

